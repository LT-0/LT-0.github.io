<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Liu Tao">





<title>【计算机网络】Stanford CS144 Labs | LT&#39;s blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">LT&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">LT&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">【计算机网络】Stanford CS144 Labs</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Liu Tao</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">October 21, 2020&nbsp;&nbsp;23:46:36</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><strong>Computer Networking 课程实验。</strong></p>
<ul>
<li><p><a href="https://cs144.github.io/" target="_blank" rel="noopener">CS144 课程网站</a></p>
</li>
<li><p>我的Labs仓库：</p>
</li>
</ul>
<ul>
<li><input checked="" disabled="" type="checkbox"> <p>Lab 0: networking warmup</p>
</li>
<li><input disabled="" type="checkbox"> <p>Lab 1: stitching substrings into a byte stream</p>
</li>
<li><input disabled="" type="checkbox"> <p>Lab 2: the TCP receiver</p>
</li>
<li><input disabled="" type="checkbox"> <p>Lab 3: the TCP sender</p>
</li>
<li><input disabled="" type="checkbox"> <p>Lab 4: the TCP connection</p>
</li>
<li><input disabled="" type="checkbox"> <p>Lab 5: the network interface</p>
</li>
<li><input disabled="" type="checkbox"> <p>Lab 6: the IP router </p>
</li>
</ul>
<h2 id="Lab-0-networking-warmup"><a href="#Lab-0-networking-warmup" class="headerlink" title="Lab 0: networking warmup"></a>Lab 0: networking warmup</h2><blockquote>
<p>Lab0 主要两个任务。其一是个简单的应用层程序，实现简单的网页内容获取。直接调用 Linux 的 TCP 协议栈接口 ,会在之后完成 lab4 时,使用自己写的 TCP 协议替换系统实现。其二是实现一个字节流读写程序。</p>
</blockquote>
<h3 id="1-Set-up-GNU-Linux-on-your-computer"><a href="#1-Set-up-GNU-Linux-on-your-computer" class="headerlink" title="1 Set up GNU/Linux on your computer"></a>1 Set up GNU/Linux on your computer</h3><p>安装课程自带的Linux镜像 [cs144](<a href="https://stanford.edu/class/cs144/vm" target="_blank" rel="noopener">https://stanford.edu/class/cs144/vm</a> howto/vm-howto-image.html) 或配置自己的Linux环境</p>
<p>账户：cs144@localhost</p>
<p>密码：lttt1998</p>
<h3 id="2-Networking-by-hand"><a href="#2-Networking-by-hand" class="headerlink" title="2 Networking by hand"></a>2 Networking by hand</h3><h4 id="2-1-Fetch-a-Web-page"><a href="#2-1-Fetch-a-Web-page" class="headerlink" title="2.1 Fetch a Web page"></a>2.1 Fetch a Web page</h4><p><code>telnet cs144.keithw.org http</code> or <code>telnet cs144.keithw.org 80</code></p>
<p>让telnet程序在你的计算机与另一台计算机（cs144.keithw.org）之间建立可靠的的字节流，并运行一个特定的服务：HTTP（Hyper-Text Transfer Protocol 超文本传输服务）</p>
<blockquote>
<p>Telnet 是 TCP/IP 协议簇中的一个虚拟终端协议，它允许连接到远程主机。 Telnet 运行在 OSI 参考模 型的应用层，它利用 TCP 来保证正确和有序的在客户机和服务器之间传输数据。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /hello HTTP/1.1</span><br><span class="line">Host: cs144.keithw.org</span><br></pre></td></tr></table></figure>

<p>等价于获取网页<a href="">http://cs144/keithw.org/hello</a>的信息。</p>
<h4 id="2-2-Send-yourself-an-email"><a href="#2-2-Send-yourself-an-email" class="headerlink" title="2.2 Send yourself an email"></a>2.2 Send yourself an email</h4><p><code>telnet 148.163.153.234 smtp</code></p>
<blockquote>
<p>SMTP( Simple Mail Transfer Protocol)，简单邮件传送协议。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HELO mycomputer.stanford.edu //等待回应&quot;250 2.1.0 Sender ok&quot;</span><br><span class="line">MAIL FROM: sunetid@stanford.edu //告知Sender，等待回应&quot;250 2.1.0 Sender ok&quot;</span><br><span class="line">RCPT TO: sunetid@stanford.edu //告知Recipient，等待回应&quot;250 2.1.5 Recipient ok&quot;</span><br><span class="line">DATA  //准备开始</span><br><span class="line">//header</span><br><span class="line">From: sunetid@stanford.edu </span><br><span class="line">To: sunetid@stanford.edu </span><br><span class="line">Subject: Hello from CS144 Lab 0!</span><br><span class="line"></span><br><span class="line">//body</span><br><span class="line">.</span><br><span class="line">QUIT</span><br></pre></td></tr></table></figure>

<h4 id="2-3-Listening-and-connecting"><a href="#2-3-Listening-and-connecting" class="headerlink" title="2.3 Listening and connecting"></a>2.3 Listening and connecting</h4><p>Telnet 既可以作为客户端程序，也可以作为服务器端：可以等待用户连接。</p>
<p><code>netcat -v -l -p 9090</code> </p>
<blockquote>
<p><code>netcat</code> 是一个能够读写TCP、UDP连接的工具， <code>-v</code> 是 verbose ，显示详细信息，<code>-l</code> 表示 listen，是在监听是否有客户端连接，<code>-p</code> 指的是监听端口）</p>
</blockquote>
<p>在另一终端运行<code>telnet localhost 9090</code></p>
<h3 id="3-Writing-a-network-program-using-an-OS-stream-socket"><a href="#3-Writing-a-network-program-using-an-OS-stream-socket" class="headerlink" title="3 Writing a network program using an OS stream socket"></a>3 Writing a network program using an OS stream socket</h3><p>下面来写一个程序来读一个网页，用的是操作系统提供的 <em>stream socket</em> ，这个 socket 看起来就像一个普通的文件描述子（和磁盘上的文件相似，也和 <code>stdin,stdout</code> 相似）当两个 <em>stream sockets</em> 连接起来时，写到其中一个 socket 中的字节会以相同的顺序从另一个 socket 中出来。</p>
<p>但是现实里因特网并不提供一个可靠的字节传输，Internet 做的事情叫做尽最大可能（best effort）地向目的地交付短数据，叫做 <em>Internet datagrams</em> 。每个数据报文都包含一些元信息（headers），指定了源地址和目标地址，以及一些净荷载（payload data）（最大约为 1500 字节）。</p>
<p>尽管网络尽可能地去发所有地报文，但是这些报文会：</p>
<ol>
<li>丢失</li>
<li>失序</li>
<li>出错</li>
<li>重复</li>
</ol>
<p>通常是由源和目标处的计算机操作系统来将这些“尽可能”交付地报文转化为“可靠的字节流传输”。</p>
<p>两个计算机必须共同协作来确保流中的每个字节都最终能够按照顺序交付。并且他们要告诉彼此自己准备接收的数据大小，这些是通过 1981 年建立的 Transmission Control Protocol （TCP）来实现的。</p>
<hr>
<p><code>Socket</code> 是一种 <code>FileDescriptor</code>，<code>TCPSocket</code> 是一种 <code>Socket</code></p>
<h4 id="FileDescriptor"><a href="#FileDescriptor" class="headerlink" title="FileDescriptor"></a>FileDescriptor</h4><p>这个类是一个 reference-count handle to a file descriptor。</p>
<p>继承关系：</p>
<p><img src="..%5Cimg%5Clab0_1.png" alt="lab0_1"></p>
<h4 id="file-descriptor-hh"><a href="#file-descriptor-hh" class="headerlink" title="file_descriptor.hh"></a><code>file_descriptor.hh</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SPONGE_LIBSPONGE_FILE_DESCRIPTOR_HH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPONGE_LIBSPONGE_FILE_DESCRIPTOR_HH</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"buffer.hh"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;array&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileDescriptor</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FDWrapper</span> &#123;</span></span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">int</span> _fd;                    </span><br><span class="line">        <span class="keyword">bool</span> _eof = <span class="literal">false</span>;          </span><br><span class="line">        <span class="keyword">bool</span> _closed = <span class="literal">false</span>;       </span><br><span class="line">        <span class="keyword">unsigned</span> _read_count = <span class="number">0</span>;   </span><br><span class="line">        <span class="keyword">unsigned</span> _write_count = <span class="number">0</span>;  </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">FDWrapper</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> fd)</span></span>;</span><br><span class="line">        ~FDWrapper();</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        FDWrapper(<span class="keyword">const</span> FDWrapper &amp;other) = <span class="keyword">delete</span>;</span><br><span class="line">        FDWrapper &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> FDWrapper &amp;other) = <span class="keyword">delete</span>;</span><br><span class="line">        FDWrapper(FDWrapper &amp;&amp;other) = <span class="keyword">delete</span>;</span><br><span class="line">        FDWrapper &amp;<span class="keyword">operator</span>=(FDWrapper &amp;&amp;other) = <span class="keyword">delete</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;FDWrapper&gt; _internal_fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private constructor used to duplicate the FileDescriptor (increase the reference count)</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">FileDescriptor</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;FDWrapper&gt; other_shared_ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register_read</span><span class="params">()</span> </span>&#123; ++_internal_fd-&gt;_read_count; &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register_write</span><span class="params">()</span> </span>&#123; ++_internal_fd-&gt;_write_count; &#125;  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">FileDescriptor</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> fd)</span></span>;</span><br><span class="line"></span><br><span class="line">    ~FileDescriptor() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">read</span><span class="params">(<span class="keyword">const</span> <span class="keyword">size_t</span> limit = <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">size_t</span>&gt;::max())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> &amp;str, <span class="keyword">const</span> <span class="keyword">size_t</span> limit = <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">size_t</span>&gt;::max())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> write(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">const</span> <span class="keyword">bool</span> write_all = <span class="literal">true</span>) &#123; <span class="keyword">return</span> write(BufferViewList(str), write_all); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> write(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;str, <span class="keyword">const</span> <span class="keyword">bool</span> write_all = <span class="literal">true</span>) &#123; <span class="keyword">return</span> write(BufferViewList(str), write_all); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> write(BufferViewList buffer, <span class="keyword">const</span> <span class="keyword">bool</span> write_all = <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123; _internal_fd-&gt;close(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">FileDescriptor <span class="title">duplicate</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_blocking</span><span class="params">(<span class="keyword">const</span> <span class="keyword">bool</span> blocking_state)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">fd_num</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _internal_fd-&gt;_fd; &#125;                         </span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">eof</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _internal_fd-&gt;_eof; &#125;                          </span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">closed</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _internal_fd-&gt;_closed; &#125;                    </span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">read_count</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _internal_fd-&gt;_read_count; &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">write_count</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _internal_fd-&gt;_write_count; &#125;  </span><br><span class="line"></span><br><span class="line">    FileDescriptor(<span class="keyword">const</span> FileDescriptor &amp;other) = <span class="keyword">delete</span>;             </span><br><span class="line">    FileDescriptor &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> FileDescriptor &amp;other) = <span class="keyword">delete</span>;  </span><br><span class="line">    FileDescriptor(FileDescriptor &amp;&amp;other) = <span class="keyword">default</span>;                 </span><br><span class="line">    FileDescriptor &amp;<span class="keyword">operator</span>=(FileDescriptor &amp;&amp;other) = <span class="keyword">default</span>;      </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// SPONGE_LIBSPONGE_FILE_DESCRIPTOR_HH</span></span></span><br></pre></td></tr></table></figure>

<h4 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h4><p>这是网络 socket（TCP,UDP,…） 的基类，继承关系如下：</p>
<p><img src="..%5Cimg%5Clab0_2.png" alt="lab0_2"></p>
<h4 id="socket-hh"><a href="#socket-hh" class="headerlink" title="socket.hh"></a><code>socket.hh</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SPONGE_LIBSPONGE_SOCKET_HH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPONGE_LIBSPONGE_SOCKET_HH</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"address.hh"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"file_descriptor.hh"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Socket</span> :</span> <span class="keyword">public</span> FileDescriptor &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="function">Address <span class="title">get_address</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;name_of_function,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> <span class="built_in">std</span>::function&lt;<span class="keyword">int</span>(<span class="keyword">int</span>, sockaddr *, <span class="keyword">socklen_t</span> *)&gt; &amp;function)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    Socket(<span class="keyword">const</span> <span class="keyword">int</span> domain, <span class="keyword">const</span> <span class="keyword">int</span> type);</span><br><span class="line"></span><br><span class="line">    Socket(FileDescriptor &amp;&amp;fd, <span class="keyword">const</span> <span class="keyword">int</span> domain, <span class="keyword">const</span> <span class="keyword">int</span> type);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> option_type&gt;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setsockopt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> level, <span class="keyword">const</span> <span class="keyword">int</span> option, <span class="keyword">const</span> option_type &amp;option_value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(<span class="keyword">const</span> Address &amp;address)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(<span class="keyword">const</span> Address &amp;address)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> how)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Address <span class="title">local_address</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">Address <span class="title">peer_address</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_reuseaddr</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UDPSocket</span> :</span> <span class="keyword">public</span> Socket &#123;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    explicit UDPSocket(FileDescriptor &amp;&amp;fd) : Socket(std::move(fd), AF_INET, SOCK_DGRAM) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    UDPSocket() : Socket(AF_INET, SOCK_DGRAM) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">received_datagram</span> &#123;</span></span><br><span class="line">        Address source_address;  </span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> payload;     </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">received_datagram <span class="title">recv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">size_t</span> mtu = <span class="number">65536</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recv</span><span class="params">(received_datagram &amp;datagram, <span class="keyword">const</span> <span class="keyword">size_t</span> mtu = <span class="number">65536</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendto</span><span class="params">(<span class="keyword">const</span> Address &amp;destination, <span class="keyword">const</span> BufferViewList &amp;payload)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">const</span> BufferViewList &amp;payload)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TCPSocket</span> :</span> <span class="keyword">public</span> Socket &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    explicit TCPSocket(FileDescriptor &amp;&amp;fd) : Socket(std::move(fd), AF_INET, SOCK_STREAM) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    TCPSocket() : Socket(AF_INET, SOCK_STREAM) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">listen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> backlog = <span class="number">16</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">TCPSocket <span class="title">accept</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStreamSocket</span> :</span> <span class="keyword">public</span> Socket &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    explicit LocalStreamSocket(FileDescriptor &amp;&amp;fd) : Socket(std::move(fd), AF_UNIX, SOCK_STREAM) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// SPONGE_LIBSPONGE_SOCKET_HH</span></span></span><br></pre></td></tr></table></figure>

<h4 id="TCPSocket"><a href="#TCPSocket" class="headerlink" title="TCPSocket"></a>TCPSocket</h4><p>是 TCP socket 的一个 wrapper ，继承关系如下：</p>
<p><img src="..%5Cimg%5Clab0_3.png" alt="在这里插入图片描述"></p>
<h4 id="Address"><a href="#Address" class="headerlink" title="Address"></a>Address</h4><p>Wrapper around IPv4 addresses and DNS operations.</p>
<h4 id="address-hh"><a href="#address-hh" class="headerlink" title="address.hh"></a><code>address.hh</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SPONGE_LIBSPONGE_ADDRESS_HH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPONGE_LIBSPONGE_ADDRESS_HH</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Raw</span> &#123;</span></span><br><span class="line">      <span class="keyword">public</span>:</span><br><span class="line">        sockaddr_storage storage&#123;&#125;;  </span><br><span class="line">        <span class="keyword">operator</span> sockaddr *();</span><br><span class="line">        <span class="keyword">operator</span> <span class="keyword">const</span> sockaddr *() <span class="keyword">const</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">socklen_t</span> _size;  </span><br><span class="line">    Raw _address&#123;&#125;;   </span><br><span class="line"></span><br><span class="line">    Address(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;node, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;service, <span class="keyword">const</span> addrinfo &amp;hints);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    Address(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;hostname, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;service);</span><br><span class="line"></span><br><span class="line">    Address(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;ip, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">uint16_t</span> port);</span><br><span class="line"></span><br><span class="line">    Address(<span class="keyword">const</span> sockaddr *addr, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Address &amp;other) <span class="keyword">const</span>;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>!=(<span class="keyword">const</span> Address &amp;other) <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="keyword">not</span> <span class="keyword">operator</span>==(other); &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="keyword">uint16_t</span>&gt; ip_port() <span class="keyword">const</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">ip</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ip_port().first; &#125;</span><br><span class="line">    <span class="keyword">uint16_t</span> port() <span class="keyword">const</span> &#123; <span class="keyword">return</span> ip_port().second; &#125;</span><br><span class="line">    <span class="keyword">uint32_t</span> ipv4_numeric() <span class="keyword">const</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">to_string</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> size() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _size; &#125;</span><br><span class="line">    <span class="keyword">operator</span> <span class="keyword">const</span> sockaddr *() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _address; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// SPONGE_LIBSPONGE_ADDRESS_HH</span></span></span><br></pre></td></tr></table></figure>

<h4 id="Writing-webget"><a href="#Writing-webget" class="headerlink" title="Writing webget"></a>Writing webget</h4><ul>
<li>SHUT_RD/WR/RDWR，先用SHUT_WR关闭写，避免服务器等待</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_URL</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span> &amp;host, <span class="keyword">const</span> <span class="built_in">string</span> &amp;path)</span> </span>&#123;</span><br><span class="line">    TCPSocket sock&#123;&#125;;</span><br><span class="line">    sock.connect(Address(host,<span class="string">"http"</span>));</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">input</span><span class="params">(<span class="string">"GET "</span>+path+<span class="string">" HTTP/1.1\r\nHost: "</span>+host+<span class="string">"\r\n\r\n"</span>)</span></span>;</span><br><span class="line">    sock.write(input);</span><br><span class="line">    <span class="comment">// If you don’t shut down your outgoing byte stream,</span></span><br><span class="line">    <span class="comment">// the server will wait around for a while for you to send</span></span><br><span class="line">    <span class="comment">// additional requests and won’t end its outgoing byte stream either.</span></span><br><span class="line">    sock.shutdown(SHUT_WR);</span><br><span class="line">    <span class="keyword">while</span>(!sock.eof())</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;sock.read();  </span><br><span class="line">    sock.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-An-in-memory-reliable-byte-stream"><a href="#4-An-in-memory-reliable-byte-stream" class="headerlink" title="4 An in-memory reliable byte stream"></a>4 An in-memory reliable byte stream</h3><p>要求实现一个有序字节流类（in-order byte stream），使之支持读写、容量控制。这个字节流类似于一个带容量的队列，从一头读，从另一头写。当流中的数据达到容量上限时，便无法再写入新的数据。特别的，写操作被分为了peek和pop两步。peek为从头部开始读取指定数量的字节，pop为弹出指定数量的字节。</p>
<p><code>byte_stream.hh</code></p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Copyclass ByteStream &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// Your code here -- add private members as necessary.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">deque</span>&lt;<span class="keyword">char</span>&gt; _buffer = &#123;&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> _capacity = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> _read_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> _write_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> _input_ended_flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> _error = <span class="literal">false</span>;  <span class="comment">//!&lt; Flag indicating that the stream suffered an error.</span></span><br><span class="line">    <span class="comment">//......</span></span><br></pre></td></tr></table></figure>

<p><code>byte_stream.cc</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">CopyByteStream::ByteStream(<span class="keyword">const</span> <span class="keyword">size_t</span> capacity) : _capacity(capacity) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ByteStream::write(<span class="keyword">const</span> <span class="built_in">string</span> &amp;data) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> len = data.length();</span><br><span class="line">    <span class="keyword">if</span> (len &gt; _capacity - _buffer.size()) &#123;</span><br><span class="line">        len = _capacity - _buffer.size();</span><br><span class="line">    &#125;</span><br><span class="line">    _write_count += len;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        _buffer.push_back(data[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] len bytes will be copied from the output side of the buffer</span></span><br><span class="line"><span class="built_in">string</span> ByteStream::peek_output(<span class="keyword">const</span> <span class="keyword">size_t</span> len) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">size_t</span> length = len;</span><br><span class="line">    <span class="keyword">if</span> (length &gt; _buffer.size()) &#123;</span><br><span class="line">        length = _buffer.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>().assign(_buffer.begin(), _buffer.begin() + length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] len bytes will be removed from the output side of the buffer</span></span><br><span class="line"><span class="keyword">void</span> ByteStream::pop_output(<span class="keyword">const</span> <span class="keyword">size_t</span> len) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> length = len;</span><br><span class="line">    <span class="keyword">if</span> (length &gt; _buffer.size()) &#123;</span><br><span class="line">        length = _buffer.size();</span><br><span class="line">    &#125;</span><br><span class="line">    _read_count += length;</span><br><span class="line">    <span class="keyword">while</span> (length--) &#123;</span><br><span class="line">        _buffer.pop_front();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ByteStream::end_input() &#123; _input_ended_flag = <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> ByteStream::input_ended() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _input_ended_flag; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ByteStream::buffer_size() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _buffer.size(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> ByteStream::buffer_empty() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _buffer.size() == <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> ByteStream::eof() <span class="keyword">const</span> &#123; <span class="keyword">return</span> buffer_empty() &amp;&amp; input_ended(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ByteStream::bytes_written() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _write_count; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ByteStream::bytes_read() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _read_count; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ByteStream::remaining_capacity() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _capacity - _buffer.size(); &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Lab-1-stitching-substrings-into-a-byte-stream"><a href="#Lab-1-stitching-substrings-into-a-byte-stream" class="headerlink" title="Lab 1: stitching substrings into a byte stream"></a>Lab 1: stitching substrings into a byte stream</h2><h2 id="Lab-2-the-TCP-receiver"><a href="#Lab-2-the-TCP-receiver" class="headerlink" title="Lab 2: the TCP receiver"></a>Lab 2: the TCP receiver</h2><h2 id="Lab-3-the-TCP-sender"><a href="#Lab-3-the-TCP-sender" class="headerlink" title="Lab 3: the TCP sender"></a>Lab 3: the TCP sender</h2><h2 id="Lab-4-the-TCP-connection"><a href="#Lab-4-the-TCP-connection" class="headerlink" title="Lab 4: the TCP connection"></a>Lab 4: the TCP connection</h2><h2 id="Lab-5-the-network-interface"><a href="#Lab-5-the-network-interface" class="headerlink" title="Lab 5: the network interface"></a>Lab 5: the network interface</h2><h2 id="Lab-6-the-IP-router"><a href="#Lab-6-the-IP-router" class="headerlink" title="Lab 6: the IP router"></a>Lab 6: the IP router</h2>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Liu Tao</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://seekmyself.com/2020/10/21/cs144/">http://seekmyself.com/2020/10/21/cs144/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY<strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"># 计算机网络</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2019/10/26/hello-world/">Hello World</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Liu Tao | Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div>
</body>
</html>
